<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Faculty · Grade Exams</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#050914;
      --card:#0f1729;
      --muted:#8f9bb8;
      --text:#e7ecf7;
      --accent:#7dd3ff;
      --accent-2:#5b8cff;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:var(--bg); color:var(--text); min-height:100vh; padding:32px;
    }
    header{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;
      margin-bottom:24px;
    }
    h1{margin:0; font-size:1.9rem}
    .btn{
      border:none; border-radius:12px; padding:12px 18px; font-weight:600; cursor:pointer;
      color:#041024; background:linear-gradient(135deg,var(--accent-2),var(--accent));
      text-decoration:none; display:inline-flex; align-items:center; gap:6px;
    }
    .table-wrapper{
      background:var(--card); border-radius:var(--radius); border:1px solid rgba(255,255,255,.08);
      padding:20px; overflow-x:auto;
    }
    table{
      width:100%; border-collapse:collapse; min-width:900px;
    }
    th,td{
      padding:12px 10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left;
    }
    th{color:var(--muted); font-weight:500; font-size:.9rem; text-transform:uppercase; letter-spacing:.03em;}
    tbody tr:last-child td{border-bottom:none}
    .small{font-size:.85rem; color:var(--muted);}
    input, textarea{
      width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.05); color:var(--text); font-family:inherit;
    }
    textarea{min-height:60px; resize:vertical;}
    form{display:grid; gap:6px;}
    .save-btn{
      border:none; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer;
      background:linear-gradient(135deg,var(--accent-2),var(--accent)); color:#041024;
      transition:all 0.3s ease;
    }
    .save-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(91,140,255,0.4);
    }
    .save-btn:active{
      transform:translateY(0);
    }
    .badge{
      display:inline-flex; align-items:center; padding:3px 10px; border-radius:999px;
      font-size:.78rem; font-weight:600; color:#041024; background:rgba(125,211,255,.8);
    }
    .messages{margin-bottom:18px;}
    .messages p{
      margin:6px 0; padding:10px 14px; border-radius:12px; background:rgba(125,211,255,.1);
      border:1px solid rgba(125,211,255,.25);
    }
    .empty{
      text-align:center; padding:40px; color:var(--muted); font-size:1rem;
    }
    .loading{opacity:0.6; pointer-events:none;}
    .success-toast{
      position:fixed; bottom:20px; right:20px; background:rgba(34,197,94,.2);
      border:1px solid rgba(34,197,94,.5); color:#86efac; padding:14px 16px;
      border-radius:8px; font-weight:600; z-index:1000; animation:slideIn 0.3s ease;
    }
    @keyframes slideIn{
      from{transform:translateX(400px);opacity:0;}
      to{transform:translateX(0);opacity:1;}
    }
  </style>
  <script>
    function submitGradeForm(formElement, event) {
      event.preventDefault();
      const btn = formElement.querySelector('button[type="submit"]') || formElement.querySelector('button[form="' + formElement.id + '"]');
      const originalText = btn ? btn.innerText : 'Save';
      if (btn) {
        btn.disabled = true;
        btn.innerText = 'Saving...';
        btn.style.opacity = '0.6';
      }
      
      // Collect all form data including fields outside the form element
      const formData = new FormData(formElement);
      
      // Get the form ID to find associated fields
      const formId = formElement.id;
      const formCounter = formId.replace('grade-form-', '');
      
      // Manually add remarks if it's in a separate cell (using form attribute)
      const remarksField = document.getElementById('remarks-' + formCounter);
      if (remarksField) {
        // Always update remarks in case it's outside the form
        if (formData.has('remarks')) {
          formData.set('remarks', remarksField.value || '');
        } else {
          formData.append('remarks', remarksField.value || '');
        }
      }
      
      // Debug: Log form data
      console.log('Submitting form data:');
      for (let [key, value] of formData.entries()) {
        console.log(key + ':', value);
      }
      
      // Use the API endpoint for grade submission
      fetch('{% url "api_submit_grade" %}', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          return response.text().then(text => {
            try {
              return JSON.parse(text);
            } catch (e) {
              throw new Error('Server error: ' + text);
            }
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          // Show success message
          showToast(data.message || 'Grade saved successfully!');
          // Update button state
          if (btn) {
            btn.innerText = '✓ Saved';
            btn.style.background = 'linear-gradient(135deg, rgba(34,197,94,0.8), rgba(34,197,94,0.6))';
          }
          // Reload page after a short delay to show updated marks
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          // Show error message
          const errorMsg = data.message || 'Failed to save grade';
          alert('Error: ' + errorMsg);
          console.error('Save failed:', data);
          if (btn) {
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.opacity = '1';
          }
        }
      })
      .catch(error => {
        console.error('Error saving grade:', error);
        if (btn) {
          btn.disabled = false;
          btn.innerText = originalText;
          btn.style.opacity = '1';
        }
        alert('Error saving grade: ' + error.message);
      });
    }
    
    function showToast(message) {
      // Remove existing toast if any
      const existingToast = document.querySelector('.success-toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      // Create new toast
      const toast = document.createElement('div');
      toast.className = 'success-toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Remove toast after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</head>
<body>
  <header>
    <div>
      <p style="margin:0;color:var(--muted);">Logged in as {{ faculty_username }}</p>
      <h1>Grade Submitted Exams</h1>
    </div>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <a class="btn" href="{% url 'faculty_dashboard' %}">← Dashboard</a>
      <a class="btn" href="{% url 'faculty_logout' %}">Logout</a>
    </div>
  </header>

  <div class="messages">
    {% if messages %}
      {% for message in messages %}
        <p>{{ message }}</p>
      {% endfor %}
    {% endif %}
  </div>

  {% if assigned_subjects %}
  <div style="background:var(--card);border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);padding:16px;margin-bottom:20px;">
    <p style="margin:0 0 8px;font-weight:600;">Your Assigned Subjects:</p>
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      {% for subject in assigned_subjects %}
      <span style="display:inline-block;padding:6px 14px;background:rgba(91,140,255,.2);border-radius:8px;font-weight:600;color:var(--accent);font-size:.9rem;">{{ subject }}</span>
      {% endfor %}
    </div>
    <p style="margin:8px 0 0;color:var(--muted);font-size:.85rem;">Only exams for these subjects are shown below.</p>
  </div>
  {% else %}
  <div style="background:rgba(220,38,38,.1);border-radius:var(--radius);border:1px solid rgba(220,38,38,.3);padding:16px;margin-bottom:20px;">
    <p style="margin:0;color:var(--muted);">No subjects assigned yet. Please contact admin to get subjects assigned before you can grade exams.</p>
  </div>
  {% endif %}

  <div class="table-wrapper">
    {% if exam_entries %}
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Subject</th>
            <th>Exam Date</th>
            <th>Attempt ID</th>
            <th>Marks</th>
            <th>Remarks</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in exam_entries %}
          <tr>
            <td>
              <strong>{{ entry.username }}</strong><br>
              <span class="small">{{ entry.semester|default:"-" }}</span>
            </td>
            <td>
              {{ entry.subject }}<br>
              <span class="small">{{ entry.file }}</span>
            </td>
            <td>
              {{ entry.exam_date|default:"—" }}<br>
              <span class="small">{{ entry.saved_at }}</span>
            </td>
            <td>
              <span class="badge">{{ entry.attempt_id }}</span>
            </td>
            <td style="width:180px;">
              <form method="post" action="{% url 'api_submit_grade' %}" id="grade-form-{{ forloop.counter }}" style="gap:8px;">
                {% csrf_token %}
                <input type="hidden" name="username" value="{{ entry.username }}">
                <input type="hidden" name="attempt_id" value="{{ entry.attempt_id }}">
                <input type="hidden" name="subject" value="{{ entry.subject }}">
                <input type="hidden" name="semester" value="{{ entry.semester }}">
                <input type="hidden" name="exam_date" value="{{ entry.exam_date_iso }}">
                <div style="display:flex;gap:8px;align-items:flex-end;">
                  <div style="flex:1;">
                    <label class="small" for="marks-{{ forloop.counter }}" style="display:block;margin-bottom:4px;">Marks</label>
                    <input id="marks-{{ forloop.counter }}" type="number" step="0.01" name="marks" value="{{ entry.marks }}" placeholder="Score" style="width:100%;">
                  </div>
                  <div style="flex:1;">
                    <label class="small" for="max-{{ forloop.counter }}" style="display:block;margin-bottom:4px;">Out of</label>
                    <input id="max-{{ forloop.counter }}" type="number" step="0.01" name="max_marks" value="{{ entry.max_marks }}" placeholder="Max">
                  </div>
                </div>
              </form>
            </td>
            <td style="width:220px;">
                <label class="small" for="remarks-{{ forloop.counter }}" style="display:block;margin-bottom:4px;">Remarks</label>
                <textarea id="remarks-{{ forloop.counter }}" name="remarks" form="grade-form-{{ forloop.counter }}" placeholder="Enter remarks" style="width:100%;min-height:40px;">{{ entry.remarks }}</textarea>
            </td>
            <td style="width:150px;">
                {% if entry.graded_at %}
                <div class="small" style="margin-bottom:8px;">By {{ entry.graded_by|default:"—" }}</div>
                <div class="small" style="margin-bottom:8px;">{{ entry.graded_at|date:"M d, Y H:i" }}</div>
                {% else %}
                <div class="small" style="margin-bottom:8px;">Not graded</div>
                {% endif %}
                <button class="save-btn" type="button" onclick="submitGradeForm(document.getElementById('grade-form-{{ forloop.counter }}'), event);" style="width:100%;margin:0;">Save</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="empty">
        No exam submissions found. Ask students to book and submit exams first.
      </div>
    {% endif %}
  </div>
</body>
</html>

